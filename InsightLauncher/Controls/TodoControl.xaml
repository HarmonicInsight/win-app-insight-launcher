<UserControl x:Class="InsightLauncher.Controls.TodoControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:InsightLauncher.Models">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal">
                <TextBlock Text="âœ“" FontSize="18" VerticalAlignment="Center"/>
                <TextBlock Text="ã‚¿ã‚¹ã‚¯"
                           Style="{StaticResource SectionHeader}"
                           Margin="8,0,0,0"/>
                <Border Background="{StaticResource PrimaryBrush}"
                        CornerRadius="10"
                        Padding="8,2"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"
                        Visibility="{Binding PendingCount, Converter={StaticResource NullToVisibilityConverter}}">
                    <TextBlock Text="{Binding PendingCount}"
                               Foreground="White"
                               FontSize="11"
                               FontWeight="SemiBold"/>
                </Border>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Style="{StaticResource GhostButton}"
                        Command="{Binding StartAddNewCommand}"
                        Padding="8,4">
                    <TextBlock Text="+ è¿½åŠ " FontSize="12" Foreground="{StaticResource PrimaryBrush}"/>
                </Button>
                <Button Style="{StaticResource IconButton}"
                        Command="{Binding RefreshCommand}">
                    <TextBlock Text="ðŸ”„" FontSize="12"/>
                </Button>
            </StackPanel>
        </Grid>

        <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <Border Grid.Row="1"
                Background="{StaticResource BackgroundSecondaryBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="12"
                Margin="0,0,0,16"
                Visibility="{Binding IsAddingNew, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBox Grid.Row="0"
                         Text="{Binding NewTodoTitle, UpdateSourceTrigger=PropertyChanged}"
                         Background="{StaticResource BackgroundCardBrush}"
                         Foreground="{StaticResource TextPrimaryBrush}"
                         BorderBrush="{StaticResource BorderBrush}"
                         Padding="8"
                         FontSize="13">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TextBox">
                                        <Border Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="4"
                                                Padding="{TemplateBinding Padding}">
                                            <ScrollViewer x:Name="PART_ContentHost"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                    <DatePicker SelectedDate="{Binding NewTodoDueDate}"
                                Background="{StaticResource BackgroundCardBrush}"
                                BorderBrush="{StaticResource BorderBrush}"
                                Width="140"/>
                    <ComboBox SelectedValue="{Binding NewTodoPriority}"
                              Margin="8,0,0,0"
                              Width="100">
                        <ComboBoxItem Content="ä½Ž" Tag="{x:Static models:TodoPriority.Low}"/>
                        <ComboBoxItem Content="ä¸­" Tag="{x:Static models:TodoPriority.Medium}" IsSelected="True"/>
                        <ComboBoxItem Content="é«˜" Tag="{x:Static models:TodoPriority.High}"/>
                    </ComboBox>
                </StackPanel>

                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                    <Button Style="{StaticResource GhostButton}"
                            Command="{Binding CancelAddNewCommand}"
                            Content="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
                            Padding="12,6"/>
                    <Button Style="{StaticResource PrimaryButton}"
                            Command="{Binding AddTodoCommand}"
                            Content="è¿½åŠ "
                            Padding="16,6"
                            Margin="8,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- å®Œäº†æ¸ˆã¿è¡¨ç¤ºåˆ‡æ›¿ -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8"
                    Visibility="{Binding IsAddingNew, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
            <CheckBox IsChecked="{Binding ShowCompleted}"
                      Foreground="{StaticResource TextSecondaryBrush}"
                      FontSize="12"
                      VerticalContentAlignment="Center">
                <TextBlock Text="å®Œäº†æ¸ˆã¿ã‚’è¡¨ç¤º" Margin="4,0,0,0"/>
            </CheckBox>
        </StackPanel>

        <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding FilteredTodos}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:TodoItem}">
                        <Border Background="{StaticResource BackgroundSecondaryBrush}"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="12"
                                Margin="0,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                                <Button Grid.Column="0"
                                        Command="{Binding DataContext.ToggleCompleteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        Width="24" Height="24"
                                        Margin="0,0,12,0">
                                    <TextBlock FontSize="16">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="â˜"/>
                                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                                        <Setter Property="Text" Value="âœ“"/>
                                                        <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Button>

                                <!-- ã‚¿ã‚¹ã‚¯å†…å®¹ -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Title}"
                                               FontSize="13"
                                               TextTrimming="CharacterEllipsis">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                                        <Setter Property="Foreground" Value="{StaticResource TextMutedBrush}"/>
                                                        <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <!-- æœŸé™ -->
                                        <TextBlock Foreground="{StaticResource TextMutedBrush}"
                                                   FontSize="11"
                                                   Visibility="{Binding DueDate, Converter={StaticResource NullToVisibilityConverter}}">
                                            <Run Text="ðŸ“…"/>
                                            <Run Text="{Binding DueDate, StringFormat=M/d}"/>
                                        </TextBlock>
                                        <!-- å„ªå…ˆåº¦ -->
                                        <Border Margin="8,0,0,0"
                                                CornerRadius="3"
                                                Padding="4,1"
                                                Visibility="{Binding Priority, Converter={StaticResource NullToVisibilityConverter}}">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Priority}" Value="{x:Static models:TodoPriority.High}">
                                                            <Setter Property="Background" Value="{StaticResource ErrorBrush}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Priority}" Value="{x:Static models:TodoPriority.Medium}">
                                                            <Setter Property="Background" Value="{StaticResource WarningBrush}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Priority}" Value="{x:Static models:TodoPriority.Low}">
                                                            <Setter Property="Background" Value="{StaticResource TextMutedBrush}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Foreground="White" FontSize="9">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Priority}" Value="{x:Static models:TodoPriority.High}">
                                                                <Setter Property="Text" Value="é«˜"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Priority}" Value="{x:Static models:TodoPriority.Medium}">
                                                                <Setter Property="Text" Value="ä¸­"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Priority}" Value="{x:Static models:TodoPriority.Low}">
                                                                <Setter Property="Text" Value="ä½Ž"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </Border>
                                    </StackPanel>
                                </StackPanel>

                                <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
                                <Button Grid.Column="2"
                                        Style="{StaticResource IconButton}"
                                        Command="{Binding DataContext.DeleteTodoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Width="28" Height="28"
                                        Opacity="0.5">
                                    <TextBlock Text="ðŸ—‘" FontSize="12"/>
                                </Button>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
